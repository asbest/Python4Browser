<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Interpreter with File Upload</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Pyodide (Python for WebAssembly) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <!-- 3. Monaco Editor (via CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling for the scrollbar in the console output */
        #console-output::-webkit-scrollbar {
            width: 8px;
        }
        #console-output::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #console-output::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #console-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        
        /* Ensures the textarea height adjusts correctly to the content */
        #console-input {
            overflow-y: hidden;
        }

        /* Styling for the resizable separator */
        #resizer {
            width: 8px;
            cursor: col-resize;
            background-color: #1f2937; /* gray-800 */
            border-left: 1px solid #4b5563; /* gray-600 */
            border-right: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.2s;
        }
        #resizer:hover {
            background-color: #374151; /* gray-700 */
        }

        #file-sidebar {
            width: 100%; /* Full width on mobile */
        }
        @media (min-width: 768px) {
            #file-sidebar {
                width: var(--sidebar-width);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen overflow-hidden">

    <!-- Loading indicator -->
    <div id="loading" class="flex-grow flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400"></div>
        <p id="loading-status" class="mt-4 text-lg text-gray-300">Initializing Pyodide (Python Runtime)...</p>
    </div>

    <!-- Main application (initially hidden) -->
    <main id="app-container" class="flex-grow flex flex-col md:flex-row overflow-hidden" style="display: none;">
    
        <!-- Left column: File manager -->
        <div id="file-sidebar" class="bg-gray-800 p-4 flex flex-col border-r border-gray-700" style="--sidebar-width: 25%;">
            <h2 class="text-lg font-semibold text-white mb-3">File Manager</h2>
            
            <!-- Action Buttons -->
            <div class="space-y-2 mb-4">
                <label for="file-uploader" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Upload Files
                </label>
                <input type="file" id="file-uploader" multiple class="hidden">

                <button id="load-script-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Load & Run Script
                </button>
                <input type="file" id="script-loader" class="hidden" accept=".py">

                <button id="save-history-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Download History
                </button>
            </div>

            <!-- Package installation -->
            <h3 class="text-md font-semibold text-gray-300 mt-4 mb-2">Install Package</h3>
            <div class="flex space-x-2">
                <input type="text" id="package-name-input" placeholder="Package name" class="flex-grow bg-gray-900 border border-gray-700 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                <button id="install-package-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">
                    Install
                </button>
            </div>
            
            <!-- Loaded files list -->
            <h3 class="text-md font-semibold text-gray-300 mt-4 mb-2">Loaded Files:</h3>
            <ul id="file-list" class="flex-grow overflow-y-auto bg-gray-900 rounded p-2">
                <!-- File list will be dynamically inserted here -->
            </ul>
        </div>

        <!-- Separator -->
        <div id="resizer" class="hidden md:block"></div>

        <!-- Right column: Console -->
        <div id="console-area" class="flex-grow flex flex-col p-4">
            <!-- The console itself (history) -->
            <div id="console-output" class="flex-grow overflow-y-auto font-mono text-sm whitespace-pre-wrap break-words">
                <!-- History will be dynamically inserted here -->
            </div>

            <!-- Input line at the bottom -->
            <div id="input-area" class="flex w-full mt-2 font-mono text-sm items-stretch">
                <span id="prompt" class="text-blue-400 flex-shrink-0 pt-1">>>>&nbsp;</span>
                <!-- Container for the Monaco Editor as an input field -->
                <div id="editor-container" class="flex-grow border border-gray-700 rounded-md" style="height: 80px;"></div>
            </div>
        </div>
    </main>

    <script type="module">
        // DOM Elements
        const loadingIndicator = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const appContainer = document.getElementById('app-container');
        const resizer = document.getElementById('resizer');
        
        // Console
        const consoleOutput = document.getElementById('console-output');
        const promptElement = document.getElementById('prompt');
        const editorContainer = document.getElementById('editor-container');
        
        // File manager
        const fileUploader = document.getElementById('file-uploader');
        const fileList = document.getElementById('file-list');
        const loadScriptBtn = document.getElementById('load-script-btn');
        const scriptLoader = document.getElementById('script-loader');
        const saveHistoryBtn = document.getElementById('save-history-btn');
        const packageNameInput = document.getElementById('package-name-input');
        const installPackageBtn = document.getElementById('install-package-btn');

        let pyodide;
        let monacoEditor;
        let codeBuffer = ""; // For multi-line input

        // --- UI Helper Functions ---

        // Function to add entries to the console history
        function addToOutput(text, type = 'stdout') {
            const line = document.createElement('div');
            
            // Remove trailing newlines, as 'div' is already a block element
            line.textContent = text.trimEnd(); 

            switch (type) {
                case 'stdin':
                    line.className = 'text-blue-300'; // User input
                    break;
                case 'stderr':
                    line.className = 'text-red-400'; // Error message
                    break;
                case 'repr':
                    line.className = 'text-gray-400'; // Result representation
                    break;
                case 'system':
                    line.className = 'text-green-400'; // System messages (upload)
                    break;
                case 'stdout':
                default:
                    line.className = 'text-gray-100'; // Standard output (print)
                    break;
            }
            consoleOutput.appendChild(line);
            
            // Always scroll to the end of the history
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // --- Main Initialization Function ---

        async function main() {
            try {
                // 1. Initialize Pyodide
                pyodide = await loadPyodide({
                    stdout: (text) => addToOutput(text, 'stdout'),
                    stderr: (text) => addToOutput(text, 'stderr')
                });

                loadingStatus.textContent = 'Python runtime loaded. Loading packages...';

                // 2. Load packages
                const packages = ['numpy', 'pandas', 'networkx', 'matplotlib'];
                loadingStatus.textContent = `Loading: ${packages.join(', ')}... (This may take a moment)`;
                await pyodide.loadPackage(packages);

                loadingStatus.textContent = 'Packages loaded. Importing aliases...';

                // 3. Load micropip to install other packages
                await pyodide.loadPackage('micropip');

                // 4. Import packages
                await pyodide.runPythonAsync(`
                    import pandas as pd
                    import numpy as np
                    import networkx as nx
                    import matplotlib.pyplot as plt
                    import io
                    import sys

                    print("Pyodide initialized.")
                    print(f"Python version: {sys.version.split(' ')[0]}")
                    print("Available libraries: pandas (pd), numpy (np), networkx (nx), matplotlib.pyplot (plt)")
                    print("Use the 'Upload Files' button to make local files available.")
                    print("--------------------------------------------------")
                `);

                // 5. Hide loading indicator and show app
                loadingIndicator.style.display = 'none';
                appContainer.style.display = 'flex';
                monacoEditor.focus();

                // 6. Set up event listeners for file uploads
                fileUploader.addEventListener('change', onFileUpload);
                loadScriptBtn.addEventListener('click', () => scriptLoader.click());
                scriptLoader.addEventListener('change', onScriptLoad);
                saveHistoryBtn.addEventListener('click', saveHistoryToFile);
                installPackageBtn.addEventListener('click', installPackage);
                packageNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        installPackage();
                    }
                });

            } catch (err) {
                loadingStatus.textContent = 'Error initializing Pyodide.';
                addToOutput(`[Startup Error] ${err.message}`, 'stderr');
            }
        }

        // --- Event Handlers ---

        // Event handler for key presses (used in editor setup)
        async function handleEnterKey() {
            const code = monacoEditor.getValue();
            monacoEditor.setValue(''); // Clear editor

            addToOutput(promptElement.textContent + code, 'stdin');

            if (code.trim() === '' && codeBuffer === '') {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
                monacoEditor.focus();
                return;
            }

            await processCode(code);
        }
        
        // Event handler for file uploads
        async function onFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            addToOutput(`[System] Loading ${files.length} file(s)...`, 'system');

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    
                    // Write the file to Pyodide's virtual file system (Emscripten FS)
                    // Files are saved in the root directory '/', which is the current working directory
                    pyodide.FS.writeFile(file.name, data, { encoding: 'binary' });

                    // Update the file list in the UI
                    const li = document.createElement('li');
                    li.className = 'text-gray-300 font-mono text-sm truncate p-1';
                    li.textContent = file.name;
                    fileList.appendChild(li);

                    // Confirmation in the console
                    addToOutput(`[System] File '${file.name}' loaded. Available as './${file.name}'`, 'system');

                } catch (err) {
                    addToOutput(`[System] Error loading '${file.name}': ${err.message}`, 'stderr');
                }
            }
            
            // Reset input to allow re-uploading the same file
            event.target.value = null; 
            monacoEditor.focus();
        }

        // Event handler for loading and running scripts
        async function onScriptLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            addToOutput(`[System] Loading and executing script '${file.name}'...`, 'system');

            try {
                const scriptContent = await file.text();

                // Echo the script content into the console output, similar to a user typing it.
                addToOutput(promptElement.textContent + scriptContent, 'stdin');

                // Use the existing processCode function to execute the script
                await processCode(scriptContent);

            } catch (err) {
                addToOutput(`[System] Error executing '${file.name}': ${err.message}`, 'stderr');
            } finally {
                // Reset file input to allow reloading the same file
                event.target.value = null;
                monacoEditor.focus();
            }
        }

        // Event handler for package installation
        async function installPackage() {
            const packageName = packageNameInput.value.trim();
            if (!packageName) {
                addToOutput('[System] Please enter a package name.', 'system');
                return;
            }

            addToOutput(`[System] Installing package '${packageName}'...`, 'system');
            installPackageBtn.disabled = true;
            installPackageBtn.textContent = '...';

            try {
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('${packageName}')
                `);
                addToOutput(`[System] Package '${packageName}' installed successfully.`, 'system');
                // Attempt to import the package to confirm installation
                pyodide.pyimport(packageName);
                addToOutput(`[System] '${packageName}' can now be imported.`, 'system');
            } catch (err) {
                addToOutput(`[System] Error installing '${packageName}': ${err.message}`, 'stderr');
            } finally {
                packageNameInput.value = '';
                installPackageBtn.disabled = false;
                installPackageBtn.textContent = 'Install';
                monacoEditor.focus();
            }
        }

        // Function to process the entered code
        async function processCode(line) {
            codeBuffer += line + "\n";
            
            monacoEditor.updateOptions({ readOnly: true });

            try {
                let result = await pyodide.runPythonAsync(codeBuffer);
                if (result !== undefined) {
                    addToOutput(pyodide.globals.get('repr')(result), 'repr');
                }
                codeBuffer = "";
                promptElement.textContent = ">>>\u00A0";
            } catch (err) {
                const errMsg = err.message;
                if (errMsg.includes("EOF") || 
                    errMsg.includes("IndentationError: expected an indented block") ||
                    errMsg.includes("SyntaxError: incomplete input")) {
                    promptElement.textContent = "... \u00A0";
                } else {
                    codeBuffer = "";
                    promptElement.textContent = ">>>\u00A0";
                }
            } finally {
                monacoEditor.updateOptions({ readOnly: false });
                monacoEditor.focus();
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        // --- Monaco Editor Initialization ---
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            monacoEditor = monaco.editor.create(editorContainer, {
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false },
                wordWrap: 'on',
                contextmenu: false,
                // Fewer UI elements for a cleaner look
                lineNumbers: 'off',
                renderLineHighlight: 'none',
                scrollbar: {
                    vertical: 'auto',
                    horizontal: 'auto'
                }
            });

            // Keyboard shortcuts for Enter (execute) and Shift+Enter (new line)
            monacoEditor.addCommand(monaco.KeyCode.Enter, handleEnterKey, '!findWidgetVisible && !suggestWidgetVisible');

            main(); // Start Pyodide initialization
        });

        // Function to save the console history
        function saveHistoryToFile() {
            const historyText = consoleOutput.innerText;
            const blob = new Blob([historyText], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'python_history.py';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            monacoEditor.focus();
        }

        // --- Logic for the resizable window ---
        resizer.addEventListener('mousedown', function(e) {
            e.preventDefault();
            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            const sidebar = document.getElementById('file-sidebar');
            const newWidth = (e.clientX / window.innerWidth) * 100;
            // Limit the width to prevent the sidebar from becoming too narrow
            if (newWidth > 15 && newWidth < 60) {
                sidebar.style.setProperty('--sidebar-width', newWidth + '%');
            }
        }

        function stopResize() {
            window.removeEventListener('mousemove', resize);
        }
    </script>
</body>
</html>
