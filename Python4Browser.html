<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python-Interpreter mit Dateiupload</title>
    <!-- 1. Tailwind CSS für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Pyodide (Python für WebAssembly) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <!-- 3. Monaco Editor (via CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling für den Scrollbar im Konsolen-Output */
        #console-output::-webkit-scrollbar {
            width: 8px;
        }
        #console-output::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #console-output::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #console-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        
        /* Sorgt dafür, dass die Textarea-Höhe korrekt an den Inhalt angepasst wird */
        #console-input {
            overflow-y: hidden;
        }

        /* Styling für die verschiebbare Trennlinie */
        #resizer {
            width: 8px;
            cursor: col-resize;
            background-color: #1f2937; /* gray-800 */
            border-left: 1px solid #4b5563; /* gray-600 */
            border-right: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.2s;
        }
        #resizer:hover {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen overflow-hidden">

    <!-- Ladeanzeige -->
    <div id="loading" class="flex-grow flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400"></div>
        <p id="loading-status" class="mt-4 text-lg text-gray-300">Pyodide (Python-Laufzeitumgebung) wird initialisiert...</p>
    </div>

    <!-- Hauptanwendung (zunächst ausgeblendet) -->
    <main id="app-container" class="flex-grow flex flex-row overflow-hidden" style="display: none;">
    
        <!-- Linke Spalte: Dateimanager -->
        <div id="file-sidebar" class="bg-gray-800 p-4 flex flex-col border-r border-gray-700" style="width: var(--sidebar-width, 25%);">
            <h2 class="text-lg font-semibold text-white mb-3">Dateimanager</h2>
            
            <!-- Action Buttons -->
            <div class="space-y-2 mb-4">
                <label for="file-uploader" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Dateien hochladen
                </label>
                <input type="file" id="file-uploader" multiple class="hidden">

                <button id="load-script-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Skript laden & ausführen
                </button>
                <input type="file" id="script-loader" class="hidden" accept=".py">

                <button id="save-history-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Verlauf herunterladen
                </button>
            </div>

            <!-- Paket-Installation -->
            <h3 class="text-md font-semibold text-gray-300 mt-4 mb-2">Paket installieren</h3>
            <div class="flex space-x-2">
                <input type="text" id="package-name-input" placeholder="Paketname" class="flex-grow bg-gray-900 border border-gray-700 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                <button id="install-package-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm">
                    Installieren
                </button>
            </div>
            
            <!-- Geladene Dateien Liste -->
            <h3 class="text-md font-semibold text-gray-300 mt-4 mb-2">Geladene Dateien:</h3>
            <ul id="file-list" class="flex-grow overflow-y-auto bg-gray-900 rounded p-2">
                <!-- Dateiliste wird hier dynamisch eingefügt -->
            </ul>
        </div>

        <!-- Trennlinie -->
        <div id="resizer"></div>

        <!-- Rechte Spalte: Konsole -->
        <div id="console-area" class="flex-grow flex flex-col p-4">
            <!-- Die Konsole selbst (Verlauf) -->
            <div id="console-output" class="flex-grow overflow-y-auto font-mono text-sm whitespace-pre-wrap break-words">
                <!-- Verlauf wird hier dynamisch eingefügt -->
            </div>

            <!-- Eingabezeile am Boden -->
            <div id="input-area" class="flex w-full mt-2 font-mono text-sm items-stretch">
                <span id="prompt" class="text-blue-400 flex-shrink-0 pt-1">>>>&nbsp;</span>
                <!-- Container für den Monaco Editor als Eingabefeld -->
                <div id="editor-container" class="flex-grow border border-gray-700 rounded-md" style="height: 80px;"></div>
            </div>
        </div>

    </main>

    <script type="module">
        // DOM-Elemente
        const loadingIndicator = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const appContainer = document.getElementById('app-container');
        const resizer = document.getElementById('resizer');
        
        // Konsole
        const consoleOutput = document.getElementById('console-output');
        const promptElement = document.getElementById('prompt');
        const editorContainer = document.getElementById('editor-container');
        
        // Dateimanager
        const fileUploader = document.getElementById('file-uploader');
        const fileList = document.getElementById('file-list');
        const loadScriptBtn = document.getElementById('load-script-btn');
        const scriptLoader = document.getElementById('script-loader');
        const saveHistoryBtn = document.getElementById('save-history-btn');
        const packageNameInput = document.getElementById('package-name-input');
        const installPackageBtn = document.getElementById('install-package-btn');


        let pyodide;
        let monacoEditor;
        let codeBuffer = ""; // Für mehrzeilige Eingaben

        // --- Hilfsfunktionen für die UI ---

        // Funktion zum Hinzufügen von Einträgen zum Konsolenverlauf
        function addToOutput(content, type = 'stdout') {
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = content;
                img.className = 'max-w-full h-auto my-2 rounded-md';
                consoleOutput.appendChild(img);
            } else {
                const line = document.createElement('div');
                line.textContent = content.trimEnd();

                switch (type) {
                    case 'stdin':
                    line.className = 'text-blue-300'; // Benutzereingabe
                    break;
                case 'stderr':
                    line.className = 'text-red-400'; // Fehlermeldung
                    break;
                case 'repr':
                    line.className = 'text-gray-400'; // Ergebnis-Repräsentation
                    break;
                case 'system':
                    line.className = 'text-green-400'; // Systemnachrichten (Upload)
                    break;
                case 'stdout':
                default:
                    line.className = 'text-gray-100'; // Standard-Ausgabe (print)
                            break;
                    }
                    consoleOutput.appendChild(line);
                }
            
            // Immer ans Ende des Verlaufs scrollen
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // --- Haupt-Initialisierungsfunktion ---

        async function main() {
            try {
                // 1. Pyodide initialisieren
                pyodide = await loadPyodide({
                    stdout: (text) => addToOutput(text, 'stdout'),
                    stderr: (text) => addToOutput(text, 'stderr')
                });

                loadingStatus.textContent = 'Python-Laufzeitumgebung geladen. Lade Pakete...';

                // 2. Pakete laden
                const packages = ['numpy', 'pandas', 'networkx', 'matplotlib'];
                loadingStatus.textContent = `Lade: ${packages.join(', ')}... (Dies kann einen Moment dauern)`;
                await pyodide.loadPackage(packages);

                loadingStatus.textContent = 'Pakete geladen. Importiere Aliase...';

                // 3. micropip laden, um weitere Pakete installieren zu können
                await pyodide.loadPackage('micropip');

                // 4. Pakete importieren und Plot-Capture-Funktion einrichten
                await pyodide.runPythonAsync(`
                    import pandas as pd
                    import numpy as np
                    import networkx as nx
                    import matplotlib.pyplot as plt
                    import io
                    import sys
                    import base64

                    # Matplotlib anweisen, das 'Agg'-Backend zu verwenden (nicht-interaktiv)
                    import matplotlib
                    matplotlib.use('Agg')

                    # Funktion, die den Benutzercode ausführt und Plots abfängt
                    def run_user_code_and_capture_plot(code):
                        # Führe den Code aus
                        exec(code, globals())

                        # Prüfe, ob eine Matplotlib-Figur existiert
                        if plt.get_fignums():
                            buf = io.BytesIO()
                            plt.savefig(buf, format='png')
                            plt.close('all') # Schließe alle Figuren für den nächsten Plot
                            buf.seek(0)
                            img_base64 = base64.b64encode(buf.read()).decode('utf-8')
                            return f"data:image/png;base64,{img_base64}"
                        return None

                    print("Pyodide initialisiert.")
                    print(f"Python-Version: {sys.version.split(' ')[0]}")
                    print("Verfügbare Bibliotheken: pandas (pd), numpy (np), networkx (nx), matplotlib.pyplot (plt)")
                    print("Verwende den 'Dateien hochladen'-Button, um lokale Dateien verfügbar zu machen.")
                    print("--------------------------------------------------")
                `);

                // 4. Ladeanzeige ausblenden und App anzeigen
                loadingIndicator.style.display = 'none';
                appContainer.style.display = 'flex';
                monacoEditor.focus();

                // 5. Event-Listener für Datei-Uploads
                fileUploader.addEventListener('change', onFileUpload);
                loadScriptBtn.addEventListener('click', () => scriptLoader.click());
                scriptLoader.addEventListener('change', onScriptLoad);
                saveHistoryBtn.addEventListener('click', saveHistoryToFile);
                installPackageBtn.addEventListener('click', installPackage);
                packageNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        installPackage();
                    }
                });

            } catch (err) {
                loadingStatus.textContent = 'Fehler beim Initialisieren von Pyodide.';
                addToOutput(`[Startup Error] ${err.message}`, 'stderr');
            }
        }

        // --- Event-Handler ---

        // Event-Handler für Tastendrücke (wird im Editor-Setup verwendet)
        async function handleEnterKey() {
            const code = monacoEditor.getValue();
            monacoEditor.setValue(''); // Editor leeren

            addToOutput(promptElement.textContent + code, 'stdin');

            if (code.trim() === '' && codeBuffer === '') {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
                monacoEditor.focus();
                return;
            }

            await processCode(code);
        }
        
        // Event-Handler für Datei-Uploads
        async function onFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            addToOutput(`[System] Lade ${files.length} Datei(en)...`, 'system');

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    
                    // Datei in das virtuelle Dateisystem von Pyodide (Emscripten FS) schreiben
                    // Dateien werden im Stammverzeichnis '/' gespeichert, was das aktuelle Arbeitsverzeichnis ist
                    pyodide.FS.writeFile(file.name, data, { encoding: 'binary' });

                    // Dateiliste in der UI aktualisieren
                    const li = document.createElement('li');
                    li.className = 'text-gray-300 font-mono text-sm truncate p-1';
                    li.textContent = file.name;
                    fileList.appendChild(li);

                    // Bestätigung in der Konsole
                    addToOutput(`[System] Datei '${file.name}' geladen. Verfügbar als './${file.name}'`, 'system');

                } catch (err) {
                    addToOutput(`[System] Fehler beim Laden von '${file.name}': ${err.message}`, 'stderr');
                }
            }
            
            // Input zurücksetzen, um erneutes Hochladen derselben Datei zu ermöglichen
            event.target.value = null; 
            monacoEditor.focus();
        }

        // Event-Handler für das Laden und Ausführen von Skripten
        async function onScriptLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            addToOutput(`[System] Lade Skript '${file.name}' und führe es aus...`, 'system');

            try {
                const scriptContent = await file.text();

                // Echo the script content into the console output, similar to a user typing it.
                addToOutput(promptElement.textContent + scriptContent, 'stdin');

                // Use the existing processCode function to execute the script
                await processCode(scriptContent);

            } catch (err) {
                addToOutput(`[System] Fehler beim Ausführen von '${file.name}': ${err.message}`, 'stderr');
            } finally {
                // Reset file input to allow reloading the same file
                event.target.value = null;
                monacoEditor.focus();
            }
        }


        // Event-Handler für die Paketinstallation
        async function installPackage() {
            const packageName = packageNameInput.value.trim();
            if (!packageName) {
                addToOutput('[System] Bitte geben Sie einen Paketnamen ein.', 'system');
                return;
            }

            addToOutput(`[System] Installiere Paket '${packageName}'...`, 'system');
            installPackageBtn.disabled = true;
            installPackageBtn.textContent = '...';

            try {
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('${packageName}')
                `);
                addToOutput(`[System] Paket '${packageName}' erfolgreich installiert.`, 'system');
                // Versuch, das Paket zu importieren, um die Installation zu bestätigen
                pyodide.pyimport(packageName);
                addToOutput(`[System] '${packageName}' kann jetzt importiert werden.`, 'system');
            } catch (err) {
                addToOutput(`[System] Fehler bei der Installation von '${packageName}': ${err.message}`, 'stderr');
            } finally {
                packageNameInput.value = '';
                installPackageBtn.disabled = false;
                installPackageBtn.textContent = 'Installieren';
                monacoEditor.focus();
            }
        }


        // Funktion zur Verarbeitung des eingegebenen Codes
        async function processCode(line) {
            codeBuffer += line + "\n";
            
            monacoEditor.updateOptions({ readOnly: true });

            try {
                // Hole die Wrapper-Funktion aus dem Python-Scope
                const run_user_code = pyodide.globals.get('run_user_code_and_capture_plot');
                // Führe den Code über die Wrapper-Funktion aus
                let result = run_user_code(codeBuffer);

                if (result !== undefined) {
                    // Prüfe, ob das Ergebnis ein Base64-Bild ist
                    if (typeof result === 'string' && result.startsWith('data:image/png;base64,')) {
                        addToOutput(result, 'image'); // Spezieller Typ für Bilder
                    } else {
                        // Andernfalls, gebe die normale Repräsentation aus
                        addToOutput(pyodide.globals.get('repr')(result), 'repr');
                    }
                }
                codeBuffer = "";
                promptElement.textContent = ">>>\u00A0";
            } catch (err) {
                const errMsg = err.message;
                if (errMsg.includes("EOF") || 
                    errMsg.includes("IndentationError: expected an indented block") ||
                    errMsg.includes("SyntaxError: incomplete input")) {
                    promptElement.textContent = "... \u00A0";
                } else {
                    codeBuffer = "";
                    promptElement.textContent = ">>>\u00A0";
                }
            } finally {
                monacoEditor.updateOptions({ readOnly: false });
                monacoEditor.focus();
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        // --- Monaco Editor Initialisierung ---
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            monacoEditor = monaco.editor.create(editorContainer, {
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false },
                wordWrap: 'on',
                contextmenu: false,
                // Weniger UI-Elemente für ein schlankeres Aussehen
                lineNumbers: 'off',
                renderLineHighlight: 'none',
                scrollbar: {
                    vertical: 'auto',
                    horizontal: 'auto'
                }
            });

            // Tastaturkürzel für Enter (Ausführen) und Shift+Enter (neue Zeile)
            monacoEditor.addCommand(monaco.KeyCode.Enter, handleEnterKey, '!findWidgetVisible && !suggestWidgetVisible');

            main(); // Pyodide-Initialisierung starten
        });

        // Funktion zum Speichern des Konsolenverlaufs
        function saveHistoryToFile() {
            const historyText = consoleOutput.innerText;
            const blob = new Blob([historyText], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'python_history.py';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            monacoEditor.focus();
        }

        // --- Logik für die anpassbare Fenstergröße ---
        resizer.addEventListener('mousedown', function(e) {
            e.preventDefault();
            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            const sidebar = document.getElementById('file-sidebar');
            const newWidth = (e.clientX / window.innerWidth) * 100;
            // Begrenzung der Breite, um zu schmales Ziehen zu verhindern
            if (newWidth > 15 && newWidth < 60) {
                sidebar.style.width = newWidth + '%';
            }
        }

        function stopResize() {
            window.removeEventListener('mousemove', resize);
        }
    </script>
</body>
</html>


