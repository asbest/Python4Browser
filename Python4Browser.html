<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python-Interpreter mit Dateiupload</title>
    <!-- 1. Tailwind CSS für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Pyodide (Python für WebAssembly) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling für den Scrollbar im Konsolen-Output */
        #console-output::-webkit-scrollbar {
            width: 8px;
        }
        #console-output::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        #console-output::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        #console-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        
        /* Sorgt dafür, dass die Textarea-Höhe korrekt an den Inhalt angepasst wird */
        #console-input {
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen overflow-hidden">

    <!-- Ladeanzeige -->
    <div id="loading" class="flex-grow flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400"></div>
        <p id="loading-status" class="mt-4 text-lg text-gray-300">Pyodide (Python-Laufzeitumgebung) wird initialisiert...</p>
    </div>

    <!-- Hauptanwendung (zunächst ausgeblendet) -->
    <main id="app-container" class="flex-grow flex flex-row overflow-hidden" style="display: none;">
    
        <!-- Linke Spalte: Dateimanager -->
        <div id="file-sidebar" class="w-1/4 bg-gray-800 p-4 flex flex-col border-r border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-3">Dateimanager</h2>
            
            <!-- Action Buttons -->
            <div class="space-y-2 mb-4">
                <label for="file-uploader" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Dateien hochladen
                </label>
                <input type="file" id="file-uploader" multiple class="hidden">

                <button id="load-script-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors w-full text-center block">
                    Skript laden & ausführen
                </button>
                <input type="file" id="script-loader" class="hidden" accept=".py">
            </div>
            
            <!-- Geladene Dateien Liste -->
            <h3 class="text-md font-semibold text-gray-300 mb-2">Geladene Dateien:</h3>
            <ul id="file-list" class="flex-grow overflow-y-auto bg-gray-900 rounded p-2">
                <!-- Dateiliste wird hier dynamisch eingefügt -->
            </ul>
        </div>

        <!-- Rechte Spalte: Konsole -->
        <div id="console-area" class="w-3/4 flex flex-col p-4">
            <!-- Die Konsole selbst (Verlauf) -->
            <div id="console-output" class="flex-grow overflow-y-auto font-mono text-sm whitespace-pre-wrap break-words">
                <!-- Verlauf wird hier dynamisch eingefügt -->
            </div>

            <!-- Eingabezeile am Boden -->
            <div id="input-area" class="flex w-full mt-2 font-mono text-sm items-start">
                <span id="prompt" class="text-blue-400 flex-shrink-0">>>>&nbsp;</span>
                <!-- \u00A0 ist ein geschütztes Leerzeichen -->
                <textarea id="console-input" 
                          rows="1" 
                          class="flex-grow bg-transparent text-gray-100 focus:outline-none resize-none ml-2"
                          placeholder="Python-Code eingeben... (Shift+Enter für Zeilenumbruch)"
                          autofocus
                          spellcheck="false"></textarea>
            </div>
        </div>

    </main>

    <script type="module">
        // DOM-Elemente
        const loadingIndicator = document.getElementById('loading');
        const loadingStatus = document.getElementById('loading-status');
        const appContainer = document.getElementById('app-container');
        
        // Konsole
        const consoleOutput = document.getElementById('console-output');
        const promptElement = document.getElementById('prompt');
        const inputElement = document.getElementById('console-input');
        
        // Dateimanager
        const fileUploader = document.getElementById('file-uploader');
        const fileList = document.getElementById('file-list');
        const loadScriptBtn = document.getElementById('load-script-btn');
        const scriptLoader = document.getElementById('script-loader');


        let pyodide;
        let codeBuffer = ""; // Für mehrzeilige Eingaben

        // --- Hilfsfunktionen für die UI ---

        // Funktion zum automatischen Anpassen der Textarea-Höhe
        function autoGrow(element) {
            element.style.height = 'auto'; // Zurücksetzen
            element.style.height = (element.scrollHeight) + 'px'; // Auf Scroll-Höhe setzen
        }
        
        inputElement.addEventListener('input', () => autoGrow(inputElement));

        // Funktion zum Hinzufügen von Einträgen zum Konsolenverlauf
        function addToOutput(text, type = 'stdout') {
            const line = document.createElement('div');
            
            // Zeilenumbrüche am Ende entfernen, da 'div' bereits ein Block-Element ist
            line.textContent = text.trimEnd(); 

            switch (type) {
                case 'stdin':
                    line.className = 'text-blue-300'; // Benutzereingabe
                    break;
                case 'stderr':
                    line.className = 'text-red-400'; // Fehlermeldung
                    break;
                case 'repr':
                    line.className = 'text-gray-400'; // Ergebnis-Repräsentation
                    break;
                case 'system':
                    line.className = 'text-green-400'; // Systemnachrichten (Upload)
                    break;
                case 'stdout':
                default:
                    line.className = 'text-gray-100'; // Standard-Ausgabe (print)
                    break;
            }
            consoleOutput.appendChild(line);
            
            // Immer ans Ende des Verlaufs scrollen
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // --- Haupt-Initialisierungsfunktion ---

        async function main() {
            try {
                // 1. Pyodide initialisieren und stdout/stderr umleiten
                pyodide = await loadPyodide({
                    stdout: (text) => addToOutput(text, 'stdout'),
                    stderr: (text) => addToOutput(text, 'stderr')
                });

                loadingStatus.textContent = 'Python-Laufzeitumgebung geladen. Lade Pakete...';

                // 2. Pakete laden
                const packages = ['numpy', 'pandas', 'networkx', 'matplotlib'];
                loadingStatus.textContent = `Lade: ${packages.join(', ')}... (Dies kann einen Moment dauern)`;
                await pyodide.loadPackage(packages);

                loadingStatus.textContent = 'Pakete geladen. Importiere Aliase...';

                // 3. Pakete importieren und Willkommensnachricht
                await pyodide.runPythonAsync(`
                    import pandas as pd
                    import numpy as np
                    import networkx as nx
                    import matplotlib.pyplot as plt
                    import io
                    import sys

                    print("Pyodide initialisiert.")
                    print(f"Python-Version: {sys.version.split(' ')[0]}")
                    print("Verfügbare Bibliotheken: pandas (pd), numpy (np), networkx (nx), matplotlib.pyplot (plt)")
                    print("Verwende den 'Dateien hochladen'-Button, um lokale Dateien verfügbar zu machen.")
                    print("--------------------------------------------------")
                `);

                // 4. Ladeanzeige ausblenden und App anzeigen
                loadingIndicator.style.display = 'none';
                appContainer.style.display = 'flex';
                inputElement.focus();

                // 5. Event-Listener für Tastatureingaben und Datei-Upload
                inputElement.addEventListener('keydown', onKeydown);
                fileUploader.addEventListener('change', onFileUpload);
                loadScriptBtn.addEventListener('click', () => scriptLoader.click());
                scriptLoader.addEventListener('change', onScriptLoad);

            } catch (err) {
                loadingStatus.textContent = 'Fehler beim Initialisieren von Pyodide.';
                addToOutput(`[Startup Error] ${err.message}`, 'stderr');
            }
        }

        // --- Event-Handler ---

        // Event-Handler für Tastendrücke in der Eingabe
        async function onKeydown(e) {
            // Code ausführen, wenn 'Enter' gedrückt wird (und nicht Shift+Enter)
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Verhindert Standard-Zeilenumbruch

                const code = inputElement.value;
                inputElement.value = ''; // Eingabefeld leeren
                autoGrow(inputElement); // Höhe zurücksetzen
                
                // Echo der Eingabe in den Verlauf
                addToOutput(promptElement.textContent + code, 'stdin');

                // Wenn der Benutzer nur Enter drückt, ohne Code...
                if (code.trim() === '' && codeBuffer === '') {
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    inputElement.focus();
                    return;
                }

                // Code-Puffer verarbeiten
                await processCode(code);
            }
        }
        
        // Event-Handler für Datei-Uploads
        async function onFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            addToOutput(`[System] Lade ${files.length} Datei(en)...`, 'system');

            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    
                    // Datei in das virtuelle Dateisystem von Pyodide (Emscripten FS) schreiben
                    // Dateien werden im Stammverzeichnis '/' gespeichert, was das aktuelle Arbeitsverzeichnis ist
                    pyodide.FS.writeFile(file.name, data, { encoding: 'binary' });

                    // Dateiliste in der UI aktualisieren
                    const li = document.createElement('li');
                    li.className = 'text-gray-300 font-mono text-sm truncate p-1';
                    li.textContent = file.name;
                    fileList.appendChild(li);

                    // Bestätigung in der Konsole
                    addToOutput(`[System] Datei '${file.name}' geladen. Verfügbar als './${file.name}'`, 'system');

                } catch (err) {
                    addToOutput(`[System] Fehler beim Laden von '${file.name}': ${err.message}`, 'stderr');
                }
            }
            
            // Input zurücksetzen, um erneutes Hochladen derselben Datei zu ermöglichen
            event.target.value = null; 
            inputElement.focus();
        }

        // Event-Handler für das Laden und Ausführen von Skripten
        async function onScriptLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            addToOutput(`[System] Lade Skript '${file.name}' und führe es aus...`, 'system');

            try {
                const scriptContent = await file.text();

                // Echo the script content into the console output, similar to a user typing it.
                addToOutput(promptElement.textContent + scriptContent, 'stdin');

                // Use the existing processCode function to execute the script
                await processCode(scriptContent);

            } catch (err) {
                addToOutput(`[System] Fehler beim Ausführen von '${file.name}': ${err.message}`, 'stderr');
            } finally {
                // Reset file input to allow reloading the same file
                event.target.value = null;
                inputElement.focus();
            }
        }


        // Funktion zur Verarbeitung des eingegebenen Codes
        async function processCode(line) {
            codeBuffer += line + "\n"; // Zeile zum Puffer hinzufügen
            
            inputElement.disabled = true; // Eingabe sperren während der Ausführung

            try {
                // Versuche, den gesamten Puffer auszuführen
                let result = await pyodide.runPythonAsync(codeBuffer);
                
                // Wenn erfolgreich, war der Code vollständig
                if (result !== undefined) {
                    addToOutput(pyodide.globals.get('repr')(result), 'repr');
                }
                
                codeBuffer = ""; // Puffer zurücksetzen
                promptElement.textContent = ">>>\u00A0"; // Prompt zurücksetzen

            } catch (err) {
                const errMsg = err.message;
                // Prüfen, ob der Fehler ein Hinweis auf einen unvollständigen Block ist
                if (errMsg.includes("EOF") || 
                    errMsg.includes("IndentationError: expected an indented block") ||
                    errMsg.includes("SyntaxError: incomplete input")) 
                {
                    // Code ist unvollständig, auf nächste Zeile warten
                    promptElement.textContent = "... \u00A0";
                } else {
                    // Echter Fehler (wurde bereits durch stderr-Redirect ausgegeben)
                    codeBuffer = ""; // Puffer zurücksetzen
                    promptElement.textContent = ">>>\u00A0"; // Prompt zurücksetzen
                }
            } finally {
                inputElement.disabled = false; // Eingabe freigeben
                inputElement.focus();
                // Sicherstellen, dass ans Ende gescrollt wird
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        // Anwendung starten
        main();
    </script>
</body>
</html>


